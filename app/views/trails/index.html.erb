<h1>Trails</h1>
<p class='uploadDescription'>
Upload a CSV of your current trail data to update this list. Note: this will replace all of your organization's existing data! Before replacing content, we recommend downloading your current data in case anything goes wrong. 
    <% if current_user.admin? %>
    <%= link_to "Current data for all sources", {action: "index", format: :json}, target: "_blank" %>
    <% else %>
    <%= link_to "Current data for #{current_user.organization.code}", {action: "index", source_id: current_user.organization_id, format: :json}, target: "_blank" %>    
    <% end %>
</p>
<%= form_tag({ action: :upload }, multipart: true) do %>
  <% if current_user.admin? %>
    <%= select_tag "source_id", options_from_collection_for_select(Organization.all, :id, :code) %>
  <% else %>
  <%= hidden_field_tag 'source_id', current_user.organization.id %>
  <% end %>
  <%= file_field_tag 'trails' %><br>
  <%= submit_tag "Submit", data: { confirm: 'Are you sure? This will replace all of your existing trail data.' } %>
<% end %>
<br>
<% if current_user.admin? %>
<p class="tableCaption">
  Showing all trails.
</p>
<% else %> 
<span class='tabLeft <%= "active" if params[:all] == "true" %>' ><%= link_to "All Trails", :action => "index", :all => "true" %></span>
<% if current_user.organization %>
<span class='tabRight <%= "active" if params[:all] == "false" || params[:all].nil? %>'><%= link_to "Only #{current_user.organization.code} Trails", :action => "index", :all => "false" %></span>
<% end %>
<% end %>
<table id='trails'>
  <thead>
    <tr>
      <th>Name</th>
      <th>Status</th>
      <th>Status Text</th>
      <th>Description</th>
      <th>Source</th>
      <th>Steward</th>
      <th>Photo</th>
      <th colspan=3>Action</th>
    </tr>
  </thead>

  <tbody>
    <% @trails.each do |trail| %>
    <tr>
      <td><%= trail.name %></td>
      <td>
        <% if trail.status == 0 %>
        Open
        <% elsif trail.status == 1 %>
        Notice
        <% elsif trail.status == 2 %>
        Closed
        <% end %>
      </td>
      <td><%= truncate(trail.statustext, length: 50) %></td>
      <td><%= truncate(trail.description, length: 50) %></td>
      <td><%= trail.source.code if trail.source %></td>
      <td><%= trail.steward.code if trail.steward %></td>
      <td>
        <%= image_tag trail.photorecord.photo.url(:thumb) unless (trail.photorecord.nil? || trail.photorecord.photo.url =~ /missing.png$/) %>
      </td>
      <% if (current_user.admin? || current_user.organization == trail.source) %>
      <td class="actions"><%= link_to 'View', trail, :class => "tableLink" %></td>
      <td class="actions"><%= link_to 'Edit', edit_trail_path(trail), :class => "tableLink" %></td>
      <td class="actions"><%= link_to 'Delete', trail, :class => "tableLink-delete", method: :delete, data: { confirm: 'Are you sure?' } %></td>
      <% end %>
    </tr>
    <% end %>
  </tbody>
</table>

<br>

